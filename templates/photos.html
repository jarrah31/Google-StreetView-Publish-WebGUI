{% extends 'base.html' %}

{% block title %}Photos{% endblock %}

{% block head %}
<!-- Date Range Picker Dependencies -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block content %}
<div class="container_photos">
    <div class="title-container">
        <h1>Photos</h1>
        <div class="view-toggle-container">
            <button id="list-view-btn" class="view-btn active" onclick="switchView('list')">List View</button>
            <button id="grid-view-btn" class="view-btn" onclick="switchView('grid')">Grid View</button>
        </div>
    </div>

    <div class="upload-section">
        <div class="photo-container db-card">
            <div class="card-header last-updated-header">
                <h2>Last Updated: {{ last_updated }}</h2>
            </div>
        </div>
    </div>
    

    
    <!-- Pagination Controls -->
    <div class="pagination-container">
        <div class="pagination-info">
            {% if per_page != 'all' %}
                {% if pagination_start is not none and pagination_end is not none %}
                    Showing {{ pagination_start }} to {{ pagination_end }} of {{ total_records }} records
                {% else %}
                    Showing {{ ((page - 1) * per_page|int) + 1 }} to {{ [page * per_page|int, total_records]|min }} of {{ total_records }} records
                {% endif %}
            {% else %}
                Showing all {{ total_records }} records
            {% endif %}
        </div>
        <div class="pagination-controls">
            <div class="rows-per-page">
                <label for="per-page">Rows per page:</label>
                <select id="per-page" onchange="changeRowsPerPage(this.value)">
                    <option value="25" {% if per_page == '25' %}selected{% endif %}>25</option>
                    <option value="50" {% if per_page == '50' %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == '100' %}selected{% endif %}>100</option>
                    <option value="all" {% if per_page == 'all' %}selected{% endif %}>All</option>
                </select>
            </div>
            
            {% if per_page != 'all' and total_pages > 1 %}
            <div class="page-nav">
                <a href="{{ url_for('list_photos_table_page', page=1, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page == 1 %}disabled{% endif %}">First</a>
                
                <a href="{{ url_for('list_photos_table_page', page=page-1, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page == 1 %}disabled{% endif %}">Prev</a>
                
                <span class="page-indicator">Page {{ page }} of {{ total_pages }}</span>
                
                <a href="{{ url_for('list_photos_table_page', page=page+1, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page >= total_pages %}disabled{% endif %}">Next</a>
                
                <a href="{{ url_for('list_photos_table_page', page=total_pages, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page >= total_pages %}disabled{% endif %}">Last</a>
            </div>
            {% endif %}
            
            {% if status_filter or places_filter or capture_date_from or capture_date_to or upload_date_from or upload_date_to %}
            <div class="clear-filters-container">
                <a href="{{ url_for('list_photos_table_page', page=1, per_page=per_page, sort_by=sort_by, sort_order=sort_order) }}" class="clear-filters-btn">Clear All Filters</a>
            </div>
            {% endif %}
        </div>
        
        <!-- Date Range Picker (moved below pagination) -->
        <div class="date-range-picker-container">
            <label for="date-range" class="sort-label">Date range:</label>
            <input type="text" id="date-range" name="daterange" class="form-control" />
        </div>
    </div>

    <!-- Sort Controls -->
    <div class="sort-controls sort-controls-left">
        <label for="sort-select" class="sort-label">Sort-by:</label>
        <select id="sort-select" onchange="updateSort(this.value)">
            <option value="maps_publish_status" {% if sort_by == 'maps_publish_status' %}selected{% endif %}>Status</option>
            <option value="view_count" {% if sort_by == 'view_count' %}selected{% endif %}>Views</option>
            <option value="capture_time" {% if sort_by == 'capture_time' %}selected{% endif %}>Capture Date</option>
            <option value="upload_time" {% if sort_by == 'upload_time' %}selected{% endif %}>Upload Date</option>
            <option value="place_names" {% if sort_by == 'place_names' %}selected{% endif %}>Places</option>
        </select>
        <a href="#" id="sort-direction-btn" onclick="toggleSortDirection(); return false;" class="page-link" data-sort-order="{{ sort_order }}">
            {% if sort_order == 'desc' %}Descending{% else %}Ascending{% endif %}
        </a>
    </div>

    <!-- Photos Table View -->
    <div id="list-view" class="custom-table-container">
        <table class="photo-table">
            <thead>
                <tr>
                    <th>
                        <a href="{{ url_for('list_photos_table_page', sort_by='photo_id', sort_order='asc' if sort_by == 'photo_id' and sort_order == 'desc' else 'desc', per_page=per_page, page=page, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}">Photo</a>
                    </th>
                    <th class="filterable-header">
                        <div class="header-content">
                            <a href="{{ url_for('list_photos_table_page', sort_by='maps_publish_status', sort_order='asc' if sort_by == 'maps_publish_status' and sort_order == 'desc' else 'desc', per_page=per_page, page=page, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}">Status</a>
                            <button class="filter-toggle" onclick="toggleFilter('status-filter')"><i class="filter-icon">▼</i></button>
                        </div>
                        <form id="status-filter-form" action="{{ url_for('list_photos_table_page') }}" method="GET" class="filter-form">
                            <input type="hidden" name="sort_by" value="{{ sort_by }}">
                            <input type="hidden" name="sort_order" value="{{ sort_order }}">
                            <input type="hidden" name="per_page" value="{{ per_page }}">
                            <input type="hidden" name="page" value="1">
                            <input type="hidden" name="places_filter" value="{{ places_filter }}">
                            <input type="hidden" name="capture_date_from" value="{{ capture_date_from }}">
                            <input type="hidden" name="capture_date_to" value="{{ capture_date_to }}">
                            <input type="hidden" name="upload_date_from" value="{{ upload_date_from }}">
                            <input type="hidden" name="upload_date_to" value="{{ upload_date_to }}">
                            
                            <div id="status-filter" class="filter-dropdown">
                                <div class="filter-dropdown-content">
                                    <div class="filter-option">
                                        <label><input type="checkbox" name="status_filter" value="all" {% if not status_filter %}checked{% endif %}> All</label>
                                    </div>
                                    
                                    {% for status in status_values %}
                                    <div class="filter-option">
                                        <label><input type="checkbox" name="status_filter" value="{{ status }}" {% if status in status_filter %}checked{% endif %}> {{ status }}</label>
                                    </div>
                                    {% endfor %}
                                    <div class="filter-actions">
                                        <button type="submit">Apply</button>
                                        <button type="button" onclick="clearStatusFilter()">Clear</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </th>
                    <th>
                        <a href="{{ url_for('list_photos_table_page', sort_by='view_count', sort_order='asc' if sort_by == 'view_count' and sort_order == 'desc' else 'desc', per_page=per_page, page=page, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}">Views</a>
                    </th>
                    <th>
                        <a href="{{ url_for('list_photos_table_page', sort_by='capture_time', sort_order='asc' if sort_by == 'capture_time' and sort_order == 'desc' else 'desc', per_page=per_page, page=page, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}">Capture Date</a>
                    </th>
                    <th>
                        <a href="{{ url_for('list_photos_table_page', sort_by='upload_time', sort_order='asc' if sort_by == 'upload_time' and sort_order == 'desc' else 'desc', per_page=per_page, page=page, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}">Upload Date</a>
                    </th>
                    <th class="filterable-header">
                        <div class="header-content">
                            <a href="{{ url_for('list_photos_table_page', sort_by='place_names', sort_order='asc' if sort_by == 'place_names' and sort_order == 'desc' else 'desc', per_page=per_page, page=page, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}">Places</a>
                            <button class="filter-toggle" onclick="toggleFilter('places-filter')"><i class="filter-icon search-icon">🔍</i></button>
                        </div>
                        <form id="places-filter-form" action="{{ url_for('list_photos_table_page') }}" method="GET" class="filter-form">
                            <input type="hidden" name="sort_by" value="{{ sort_by }}">
                            <input type="hidden" name="sort_order" value="{{ sort_order }}">
                            <input type="hidden" name="per_page" value="{{ per_page }}">
                            <input type="hidden" name="page" value="1">
                            <input type="hidden" name="status_filter" value="{{ status_filter }}">
                            <input type="hidden" name="capture_date_from" value="{{ capture_date_from }}">
                            <input type="hidden" name="capture_date_to" value="{{ capture_date_to }}">
                            <input type="hidden" name="upload_date_from" value="{{ upload_date_from }}">
                            <input type="hidden" name="upload_date_to" value="{{ upload_date_to }}">
                            
                            <div id="places-filter" class="filter-dropdown">
                                <div class="filter-dropdown-content">
                                    <div class="search-filter">
                                        <input type="text" name="places_filter" id="places-search" placeholder="Search places..." value="{{ places_filter }}">
                                    </div>
                                    <div class="filter-actions">
                                        <button type="submit">Apply</button>
                                        <button type="button" onclick="clearPlacesFilter()">Clear</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </th>
                    <th>Connections</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="photo-table-body">
                {% for photo in photos %}
                <tr class="photo-row">
                    <td>
                        <a href="{{ photo.share_link }}" target="_blank" title="View on Google Maps">
                            View
                        </a>
                    </td>
                    <td>
                        {% if photo.maps_publish_status %}
                            {{ photo.maps_publish_status }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ photo.view_count|default('0') }}</td>
                    <td>
                        {% if photo.capture_time %}
                            {{ photo.capture_time|replace("T00:00:00Z", "")|replace("T", " ")|replace("Z", "") }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if photo.upload_time %}
                            {{ photo.upload_time.split("T")[0] }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        {% if photo.place_names %}
                            {{ photo.place_names }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>{{ photo.connection_count }}</td>
                    <td>
                        <select class="action-select" onchange="if(this.value) { if(this.value === 'delete:{{ photo.photo_id }}') { confirmDelete('{{ photo.photo_id }}'); this.value = ''; } else { window.location.href=this.value; } }">
                            <option value="">Select</option>
                            <option value="{{ url_for('edit_photo', photo_id=photo.photo_id) }}">Edit Photo</option>
                            <option value="{{ url_for('edit_connections', photo_id=photo.photo_id) }}">Edit Connections</option>
                            <option value="delete:{{ photo.photo_id }}" class="delete-option">Delete Photo</option>
                        </select>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Photos Grid View -->
    <div id="grid-view" class="main-container" style="display: none;">
        {% for photo in photos %}
            <div class="photo-container grid-item">
                <a href="{{ photo.share_link }}" target="_blank">
                    {% if photo.thumbnail_url %}
                        <img src="{{ photo.thumbnail_url }}" alt="Photo thumbnail" class="grid-thumbnail-image">
                    {% elif photo.photo_id %}
                        <img src="https://streetviewpublish.googleapis.com/v1/photos/{{ photo.photo_id }}:getDownloadUrl?key={{ api_key }}" alt="Photo thumbnail" class="grid-thumbnail-image">
                    {% else %}
                        <img src="{{ url_for('static', filename='icons8-panorama-96-favicon.png') }}" alt="No image available" class="grid-thumbnail-image">
                    {% endif %}
                </a>
                {% if photo.place_names %}
                    <p>Place: {{ photo.place_names }}</p>
                {% else %}
                    <p>Place: N/A</p>
                {% endif %}
                <p>Published Status: {{ photo.maps_publish_status|default('N/A') }}</p>
                <p>View count: {{ photo.view_count|default('0') }}</p>
                <p>Capture time: {{ photo.capture_time|replace("T00:00:00Z", "")|replace("T", " ")|replace("Z", "")|default('N/A') }}</p>
                <p>Upload time: {{ photo.upload_time.split("T")[0]|default('N/A') }}</p>
                <p>Connections: {{ photo.connection_count }}</p>
                <div class="button-container">
                    <a href="{{ url_for('edit_photo', photo_id=photo.photo_id) }}" class="grid-button">Edit Photo</a>
                    <a href="{{ url_for('edit_connections', photo_id=photo.photo_id) }}" class="grid-button">Edit Connections</a>
                    <a href="#" class="grid-button delete-button" onclick="confirmDelete('{{ photo.photo_id }}'); return false;">Delete</a>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Bottom Pagination Controls -->
    {% if per_page != 'all' and total_pages > 1 %}
    <div class="pagination-container bottom" style="margin-top: 30px;">
        <div class="pagination-controls">
            <div class="page-nav">
                <a href="{{ url_for('list_photos_table_page', page=1, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page == 1 %}disabled{% endif %}">First</a>
                
                <a href="{{ url_for('list_photos_table_page', page=page-1, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page == 1 %}disabled{% endif %}">Prev</a>
                
                <span class="page-indicator">Page {{ page }} of {{ total_pages }}</span>
                
                <a href="{{ url_for('list_photos_table_page', page=page+1, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page >= total_pages %}disabled{% endif %}">Next</a>
                
                <a href="{{ url_for('list_photos_table_page', page=total_pages, per_page=per_page, sort_by=sort_by, sort_order=sort_order, status_filter=status_filter, places_filter=places_filter, capture_date_from=capture_date_from, capture_date_to=capture_date_to, upload_date_from=upload_date_from, upload_date_to=upload_date_to) }}" class="page-link {% if page >= total_pages %}disabled{% endif %}">Last</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="delete-modal">
    <div class="delete-modal-content">
        <div class="delete-modal-header">
            <h3>Delete Photo</h3>
            <span class="delete-modal-close">&times;</span>
        </div>
        <div class="delete-modal-body">
            <p>Are you sure you want to delete this photo? This action cannot be undone.</p>
        </div>
        <div class="delete-modal-actions">
            <button class="delete-cancel-btn">Cancel</button>
            <form id="delete-form" action="{{ url_for('delete_photo') }}" method="POST">
                <input type="hidden" name="photo_id" id="delete-photo-id" value="">
                <button type="submit" class="delete-confirm-btn">Delete</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize date range picker
    $(document).ready(function() {
        // Set default dates from URL parameters if they exist
        const urlParams = new URLSearchParams(window.location.search);
        let startDate = null;
        let endDate = null;
        
        // Check if capture date filters are already set
        if (urlParams.has('capture_date_from') || urlParams.has('capture_date_to')) {
            // Format for capture_date_from is YYYY-MM in URL, but we need YYYY-MM-DD for daterangepicker
            if (urlParams.has('capture_date_from')) {
                const fromParam = urlParams.get('capture_date_from');
                startDate = moment(fromParam + '-01', 'YYYY-MM-DD');
            }
            
            if (urlParams.has('capture_date_to')) {
                const toParam = urlParams.get('capture_date_to');
                // Get the last day of the month for the end date
                const year = parseInt(toParam.split('-')[0]);
                const month = parseInt(toParam.split('-')[1]);
                const lastDay = new Date(year, month, 0).getDate(); // Get last day of month
                endDate = moment(toParam + '-' + lastDay, 'YYYY-MM-DD');
            }
        }
        
        // Initialize with detected dates or default to no selection
        $('#date-range').daterangepicker({
            opens: 'left',
            autoApply: false,
            autoUpdateInput: false, // Don't update the input value automatically
            locale: {
                format: 'YYYY-MM-DD',
                separator: ' to ',
                applyLabel: 'Apply',
                cancelLabel: 'Clear'
            },
            startDate: startDate || moment().subtract(29, 'days'),
            endDate: endDate || moment(),
            ranges: {
               'Today': [moment(), moment()],
               'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
               'Last 7 Days': [moment().subtract(6, 'days'), moment()],
               'Last 14 Days': [moment().subtract(14, 'days'), moment()],
               'This Month': [moment().startOf('month'), moment().endOf('month')],
               'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
               'Last 2 Months': [moment().subtract(2, 'months'), moment()],
               'Last 6 Months': [moment().subtract(6, 'months'), moment()],
               'This Year': [moment().startOf('year'), moment().endOf('year')],
               'Last Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')]
            }
        });

        // Set initial input value if we have URL parameters
        if (startDate && endDate) {
            $('#date-range').val(startDate.format('YYYY-MM-DD') + ' to ' + endDate.format('YYYY-MM-DD'));
        } else {
            // Otherwise, make sure the input is empty
            $('#date-range').val('');
        }

        // Handle date range picker clear button
        $('#date-range').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
            
            // Clear capture date filters from URL and reload
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.delete('capture_date_from');
            currentUrl.searchParams.delete('capture_date_to');
            currentUrl.searchParams.set('page', '1'); // Reset to first page when changing filter
            window.location.href = currentUrl.toString();
        });

        // Handle date range picker apply button
        $('#date-range').on('apply.daterangepicker', function(ev, picker) {
            // Format the display in the input field
            $(this).val(picker.startDate.format('YYYY-MM-DD') + ' to ' + picker.endDate.format('YYYY-MM-DD'));
            
            // Update URL with filtered months (backend expects YYYY-MM format)
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('capture_date_from', picker.startDate.format('YYYY-MM'));
            currentUrl.searchParams.set('capture_date_to', picker.endDate.format('YYYY-MM'));
            currentUrl.searchParams.set('page', '1'); // Reset to first page when changing filter
            window.location.href = currentUrl.toString();
        });
    });

    // Initialize the view based on local storage or default to list view
    document.addEventListener('DOMContentLoaded', function() {
        const selects = document.querySelectorAll('.action-select');
        selects.forEach(select => {
            select.value = '';
        });
        
        // Initialize filters
        initializeFilters();
        
        // Initialize view from localStorage or default to list view
        const currentView = localStorage.getItem('photoViewPreference') || 'list';
        switchView(currentView);
    });
    
    // Function to switch between list and grid views
    function switchView(viewType) {
        const listView = document.getElementById('list-view');
        const gridView = document.getElementById('grid-view');
        const listBtn = document.getElementById('list-view-btn');
        const gridBtn = document.getElementById('grid-view-btn');
        const sortControls = document.querySelector('.sort-controls');
        
        if (viewType === 'grid') {
            listView.style.display = 'none';
            gridView.style.display = 'flex';
            listBtn.classList.remove('active');
            gridBtn.classList.add('active');
            sortControls.style.display = 'flex';
        } else {
            listView.style.display = 'block';
            gridView.style.display = 'none';
            listBtn.classList.add('active');
            gridBtn.classList.remove('active');
            sortControls.style.display = 'none';
        }
        
        // Save preference
        localStorage.setItem('photoViewPreference', viewType);
    }
    
    // Function to change the number of rows per page
    function changeRowsPerPage(perPage) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('per_page', perPage);
        currentUrl.searchParams.set('page', '1'); // Reset to first page when changing rows per page
        window.location.href = currentUrl.toString();
    }
    
    // Filtering functionality
    function initializeFilters() {
        // Close all filter dropdowns initially
        document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
        });
        
        // Handle special case for "all" checkbox in status filter
        const allStatusCheckbox = document.querySelector('input[name="status_filter"][value="all"]');
        const otherStatusCheckboxes = document.querySelectorAll('input[name="status_filter"]:not([value="all"])');
        
        if (allStatusCheckbox) {
            allStatusCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    otherStatusCheckboxes.forEach(cb => {
                        cb.checked = false;
                    });
                }
            });
            
            otherStatusCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        allStatusCheckbox.checked = false;
                    } else if (!document.querySelector('input[name="status_filter"]:not([value="all"]):checked')) {
                        // If no other checkboxes are checked, check the "all" checkbox
                        allStatusCheckbox.checked = true;
                    }
                });
            });
        }
    }
    
    function toggleFilter(filterId) {
        const filterElement = document.getElementById(filterId);
        document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
            if (dropdown.id !== filterId) {
                dropdown.style.display = 'none';
            }
        });
        
        if (filterElement.style.display === 'block') {
            filterElement.style.display = 'none';
        } else {
            filterElement.style.display = 'block';
            
            // Auto-focus on the places search input when opening the places filter
            if (filterId === 'places-filter') {
                setTimeout(() => {
                    const placesSearchInput = document.getElementById('places-search');
                    if (placesSearchInput) {
                        placesSearchInput.focus();
                    }
                }, 50);
            }
        }
        
        // Close filter dropdown when clicking outside
        document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-toggle')) {
                filterElement.style.display = 'none';
                document.removeEventListener('click', closeDropdown);
            }
        });
    }
    
    function clearStatusFilter() {
        // Check the "all" checkbox and uncheck others
        const allCheckbox = document.querySelector('input[name="status_filter"][value="all"]');
        if (allCheckbox) {
            allCheckbox.checked = true;
        }
        
        const otherCheckboxes = document.querySelectorAll('input[name="status_filter"]:not([value="all"])');
        otherCheckboxes.forEach(cb => {
            cb.checked = false;
        });
        
        // Submit the form
        document.getElementById('status-filter-form').submit();
    }
    
    function clearCaptureDateFilter() {
        const form = document.getElementById('capture-date-filter-form');
        const captureFromInput = form.querySelector('input[name="capture_date_from"]');
        const captureToInput = form.querySelector('input[name="capture_date_to"]');
        
        captureFromInput.value = '';
        captureToInput.value = '';
        
        form.submit();
    }
    
    function clearUploadDateFilter() {
        const form = document.getElementById('upload-date-filter-form');
        const uploadFromInput = form.querySelector('input[name="upload_date_from"]');
        const uploadToInput = form.querySelector('input[name="upload_date_to"]');
        
        uploadFromInput.value = '';
        uploadToInput.value = '';
        
        form.submit();
    }
    
    function clearPlacesFilter() {
        const form = document.getElementById('places-filter-form');
        const placesInput = form.querySelector('input[name="places_filter"]');
        
        placesInput.value = '';
        
        form.submit();
    }

    // Function to update sort
    function updateSort(sortBy) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('sort_by', sortBy);
        currentUrl.searchParams.set('page', '1'); // Reset to first page when changing sort
        window.location.href = currentUrl.toString();
    }

    // Function to toggle sort direction
    function toggleSortDirection() {
        const sortDirectionBtn = document.getElementById('sort-direction-btn');
        const currentSortOrder = sortDirectionBtn.getAttribute('data-sort-order');
        const newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('sort_order', newSortOrder);
        currentUrl.searchParams.set('page', '1'); // Reset to first page when changing sort direction
        window.location.href = currentUrl.toString();
    }
    
    // Delete photo confirmation functions
    function confirmDelete(photoId) {
        // Set the photo ID in the hidden input field
        document.getElementById('delete-photo-id').value = photoId;
        
        // Show the delete confirmation modal
        const modal = document.getElementById('delete-modal');
        modal.style.display = 'block';
        
        // Add event listeners for the close button and cancel button
        const closeBtn = document.querySelector('.delete-modal-close');
        const cancelBtn = document.querySelector('.delete-cancel-btn');
        
        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }
        
        cancelBtn.onclick = function() {
            modal.style.display = 'none';
        }
        
        // Close the modal when clicking outside of it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}